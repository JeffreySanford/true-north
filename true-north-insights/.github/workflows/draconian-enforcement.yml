name: Draconian Angular Enforcement Pipeline

on:
  push:
    branches: [ master, develop ]
  pull_request:
    branches: [ master ]

env:
  NODE_VERSION: '18'
  DRACONIAN_MODE: 'strict'

jobs:
  # PHASE 1: CRITICAL VIOLATIONS - Zero Tolerance
  critical-validation:
    name: ðŸš¨ Critical Violations Check
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: Install Dependencies
        run: |
          npm ci
          cd tools && npm ci
          
      - name: ðŸ›¡ï¸ DRACONIAN LINTING - Zero Tolerance
        run: |
          echo "ðŸ” Running draconian linting with zero tolerance..."
          npm run lint:strict
          
      - name: ðŸ”’ TYPE SAFETY VALIDATION - Strict Mode
        run: |
          echo "ðŸ” Validating type safety with strict TypeScript..."
          npx tsc --noEmit --strict
          
      - name: ðŸš« ANTI-PATTERN DETECTION
        run: |
          echo "ðŸ” Scanning for forbidden patterns..."
          # Check for standalone components
          if grep -r "standalone.*true" --include="*.ts" src/; then
            echo "âŒ DRACONIAN VIOLATION: Standalone components detected"
            exit 1
          fi
          
          # Check for inject() usage
          if grep -r "inject(" --include="*.ts" src/ --exclude-dir=node_modules; then
            echo "âŒ DRACONIAN VIOLATION: inject() function usage detected"
            exit 1
          fi
          
          # Check for async/await in services
          if grep -r -A5 -B5 "async.*(" --include="*.service.ts" src/; then
            echo "âŒ DRACONIAN VIOLATION: async/await in services detected"
            exit 1
          fi
          
          echo "âœ… No anti-patterns detected"

  # PHASE 2: COMPREHENSIVE TESTING
  comprehensive-testing:
    name: ðŸ§ª Comprehensive Testing Suite
    runs-on: ubuntu-latest
    needs: critical-validation
    timeout-minutes: 20
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: Install Dependencies
        run: npm ci
        
      - name: ðŸŽ¯ UNIT TESTING - Coverage Required
        run: |
          echo "ðŸ§ª Running unit tests with coverage requirements..."
          npm run test:coverage
          
      - name: ðŸ“Š COVERAGE VALIDATION - Federal Standards
        run: |
          echo "ðŸ“Š Validating test coverage meets federal requirements..."
          # Validate coverage is >= 95%
          COVERAGE=$(npx nyc report --reporter=text-summary | grep "Lines" | grep -o '[0-9.]*%' | head -1 | sed 's/%//')
          echo "Current coverage: ${COVERAGE}%"
          if (( $(echo "$COVERAGE < 95" | bc -l) )); then
            echo "âŒ COVERAGE VIOLATION: ${COVERAGE}% is below required 95%"
            exit 1
          fi
          echo "âœ… Coverage requirement met: ${COVERAGE}%"
          
      - name: ðŸŽ­ E2E TESTING - Multi-Browser
        run: |
          echo "ðŸŽ­ Running E2E tests across multiple browsers..."
          npm run test:e2e
          
      - name: ðŸ” OBSERVABLE PATTERN VALIDATION
        run: |
          echo "ðŸ” Validating Observable patterns in services..."
          # Check that all service methods return Observables
          for file in $(find src -name "*.service.ts"); do
            if grep -q "Promise\|async" "$file"; then
              echo "âŒ OBSERVABLE VIOLATION in $file: Found Promise or async patterns"
              exit 1
            fi
          done
          echo "âœ… All services use Observable patterns"

  # PHASE 3: PERFORMANCE VALIDATION
  performance-validation:
    name: âš¡ Performance & Bundle Validation
    runs-on: ubuntu-latest
    needs: comprehensive-testing
    timeout-minutes: 15
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: Install Dependencies
        run: |
          npm ci
          cd tools && npm ci
          
      - name: ðŸš€ PRODUCTION BUILD - Performance Test
        run: |
          echo "ðŸš€ Building for production with performance validation..."
          npm run build:prod
          
      - name: ðŸ“¦ BUNDLE SIZE VALIDATION - Federal Limits
        run: |
          echo "ðŸ“¦ Validating bundle size meets federal requirements..."
          npm run validate:bundle
          
      - name: âš¡ BUILD PERFORMANCE CHECK
        run: |
          echo "âš¡ Validating build performance..."
          START_TIME=$(date +%s)
          npm run build:prod
          END_TIME=$(date +%s)
          BUILD_TIME=$((END_TIME - START_TIME))
          
          echo "Build time: ${BUILD_TIME} seconds"
          if [ $BUILD_TIME -gt 45 ]; then
            echo "âŒ BUILD PERFORMANCE VIOLATION: ${BUILD_TIME}s exceeds 45s limit"
            exit 1
          fi
          echo "âœ… Build performance meets requirements: ${BUILD_TIME}s"
          
      - name: ðŸŽ¯ LIGHTHOUSE AUDIT
        uses: treosh/lighthouse-ci-action@v9
        with:
          configPath: '.lighthouserc.json'
          
  # PHASE 4: SECURITY & COMPLIANCE
  security-compliance:
    name: ðŸ” Security & Federal Compliance
    runs-on: ubuntu-latest
    needs: performance-validation
    timeout-minutes: 10
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: Install Dependencies
        run: npm ci
        
      - name: ðŸ›¡ï¸ SECURITY AUDIT - Zero Vulnerabilities
        run: |
          echo "ðŸ›¡ï¸ Running security audit with zero tolerance..."
          npm audit --audit-level high
          
      - name: ðŸ” DEPENDENCY VALIDATION
        run: |
          echo "ðŸ” Validating dependencies for federal compliance..."
          # Check for vulnerable packages
          npm audit --json > audit.json
          CRITICAL=$(cat audit.json | jq '.vulnerabilities | to_entries | map(select(.value.severity == "critical")) | length')
          HIGH=$(cat audit.json | jq '.vulnerabilities | to_entries | map(select(.value.severity == "high")) | length')
          
          if [ "$CRITICAL" -gt 0 ] || [ "$HIGH" -gt 0 ]; then
            echo "âŒ SECURITY VIOLATION: Found $CRITICAL critical and $HIGH high severity vulnerabilities"
            exit 1
          fi
          echo "âœ… No critical or high severity vulnerabilities found"
          
      - name: ðŸ“‹ COMPLIANCE DOCUMENTATION CHECK
        run: |
          echo "ðŸ“‹ Validating compliance documentation..."
          # Check for required documentation
          required_docs=(
            "documentation/development/DRACONIAN_ANGULAR_STANDARDS.md"
            "documentation/development/REQUIREMENTS_SPECIFICATION.md"
            "documentation/development/PROJECT_STATUS.md"
          )
          
          for doc in "${required_docs[@]}"; do
            if [ ! -f "$doc" ]; then
              echo "âŒ COMPLIANCE VIOLATION: Missing required document: $doc"
              exit 1
            fi
          done
          echo "âœ… All required compliance documentation present"

  # PHASE 5: DEPLOYMENT READINESS
  deployment-readiness:
    name: ðŸš€ Deployment Readiness Check
    runs-on: ubuntu-latest
    needs: security-compliance
    if: github.ref == 'refs/heads/master'
    timeout-minutes: 5
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        
      - name: ðŸ“Š FINAL VALIDATION SUMMARY
        run: |
          echo "ðŸ“Š DRACONIAN VALIDATION COMPLETE - DEPLOYMENT READY"
          echo ""
          echo "âœ… Critical Violations: PASSED (Zero tolerance enforcement)"
          echo "âœ… Comprehensive Testing: PASSED (>95% coverage)"
          echo "âœ… Performance Validation: PASSED (Bundle <2MB, Build <45s)"
          echo "âœ… Security Compliance: PASSED (Zero vulnerabilities)"
          echo "âœ… Federal Documentation: PASSED (All requirements met)"
          echo ""
          echo "ðŸŽ¯ LEGENDARY STANDARDS MAINTAINED - READY FOR PRODUCTION"
          
      - name: ðŸ† SUCCESS NOTIFICATION
        if: success()
        run: |
          echo "ðŸ† DRACONIAN ENFORCEMENT SUCCESS"
          echo "All validation phases completed successfully."
          echo "Code meets federal contracting standards."
          echo "Deployment authorized for production environment."

  # FAILURE HANDLING
  failure-notification:
    name: âŒ Failure Notification
    runs-on: ubuntu-latest
    needs: [critical-validation, comprehensive-testing, performance-validation, security-compliance]
    if: failure()
    
    steps:
      - name: ðŸ’¥ VALIDATION FAILURE ALERT
        run: |
          echo "ðŸ’¥ DRACONIAN VALIDATION FAILED"
          echo ""
          echo "âŒ One or more validation phases failed"
          echo "âŒ Code does NOT meet draconian standards"
          echo "âŒ Deployment BLOCKED until violations are resolved"
          echo ""
          echo "ðŸ› ï¸  Required Actions:"
          echo "   1. Fix all ESLint violations (zero tolerance)"
          echo "   2. Ensure 100% test coverage"
          echo "   3. Resolve security vulnerabilities"
          echo "   4. Meet performance requirements"
          echo "   5. Complete compliance documentation"
          echo ""
          echo "ðŸ’ª Legendary standards demand legendary commitment!"
          exit 1